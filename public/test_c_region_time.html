<style>
    #chart-wrapper {
      display: inline-block;
      position: relative;
      width: 800px;
      height: 500px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script src="/js/bootstrap-datepicker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js" integrity="sha512-R/QOHLpV1Ggq22vfDAWYOaMd5RopHrJNMxi8/lJu8Oihwi4Ho4BRFeiMiCefn9rasajKjnx9/fTQ/xkWnkDACg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<link href="css/styles.css" rel="stylesheet" />
<link href="/css/datepicker.css" rel="stylesheet" type="text/css" />

<div>
    <div class="btn-group btn-group-toggle" data-toggle="buttons">
    <select id="option_feature">
        <option value="" selected="selected">Select Category</option>
        <option value="pcf_violation_category">PCF Violation Category</option>
        <option value="day_or_night">test</option>
    </select>
    </div>
</div>
<div>
    <select class="option_county" id="county_1">
        <option value="" selected="selected">Select County</option>
    </select>
    
    <select class="option_city county_1" id="city_1">
        <option value="" selected="selected">Select City</option>
    </select>

    <select class="option_county" id="county_2">
        <option value="" selected="selected">Select County</option>
    </select>
    
    <select class="option_city county_2" id="city_2">
        <option value="" selected="selected">Select City</option>
    </select>

    <select id="option_category_val">
        <option value="" selected="selected">Select Value</option>
    </select>
</div>

<div>
    <div class="tab">
        <button class="tablinks" onclick="plotLine()">Line</button>
        <button class="tablinks" onclick="plotStack()">Stack</button>
    </div>
</div>

<div id="chart-wrapper">
    <canvas id="my-chart"></canvas>
</div>
  


<script>
const ctx = document.getElementById('my-chart');
const feature = document.getElementById("option_feature");

var labels = {}
var chart;
var dataset_data;
var category_values;
var lineChartData;
var stackChartData;
var selected_cities = {};
var data_labels;
function init_data(){
  dataset_data = {};
  data_labels = [];
  category_values = [];
  data_labels = [];
}

function reset_dataset(){
    lineChartData=
    {
        type: 'line',
        data:{
            datasets: [],
            spanGaps: true
    }};
    stackChartData=
    {
        type: 'bar',
        data:{
            datasets: []
        },
        options: {
            plugins: {
                title: {
                display: true,
                text: 'Chart.js Bar Chart - Stacked'
                },
            },
            responsive: true,
            scales: {
                x: {
                stacked: true,
                },
                y: {
                stacked: true
                }
            }
        }
    };

}


function loadData(url) {
  fetch(url).then(function(response) {
      return response.json();
  }).then(function(data) {
      if (data.success) {
        init_data();
        data = data.payload;
        // console.log(data)        
        let keys = Object.keys(data[0]);
        curr_feature = keys[0];
        for(i in data){
            d = data[i];
            feature_val = d[curr_feature];
            percent = d["percent"];
            collisions = d["num_collisions"];
            year = d['year'];
            county = d['county_ID'].toString();
            city = d['city_ID'].toString();
            if(county.length == 1){
                county = "0" + county;
            }
            if(city.length == 1){
                city = "0" + city;
            }
            if((data_labels.indexOf(year) === -1)){
                data_labels.push(year);
            }
            county_city = "" + county + city;
            if(!dataset_data[county_city]) dataset_data[county_city] = {}
            if(!dataset_data[county_city][feature_val]) dataset_data[county_city][feature_val] = []
            dataset_data[county_city][feature_val].push({x:year, y:collisions});
            if( (category_values.indexOf(feature_val) === -1)){
                category_values.push(feature_val);
            }

        }
        $("#option_category_val").find('option').not(':first').remove()
        for (i in category_values){
            $("#option_category_val").append(new Option(category_values[i]));
        }
      }
  })
}

function get_dataset(chart_type){
    if(chart_type == 'line'){
        lineChartData.label = data_labels;
        lineChartData.data.labels = data_labels;
        selected_cat_val = $("#option_category_val")[0].value;
        var city_name;
        for (const [key, value] of Object.entries(dataset_data)) {
            if(labels["county_1"][key]){
                city_name = labels["county_1"][key];
            }
            // if((key in Object.keys(labels["county_1"]))){
            //     city_name = labels["county_1"][key];
            // }
            else{
                city_name = labels["county_2"][key];
            }

            lineChartData.data.datasets.push({
                label: city_name,
                data: value[selected_cat_val]
            })
        }
    }
    else if(chart_type == 'stack'){
        stackChartData.label = data_labels;
        stackChartData.data.labels = data_labels;
        selected_cat_val = $("#option_category_val")[0].value;
        var city_name;
        for (const [key, value] of Object.entries(dataset_data)) {
            if(labels["county_1"][key]){
                city_name = labels["county_1"][key];
            }
            // if((key in Object.keys(labels["county_1"]))){
            //     city_name = labels["county_1"][key];
            // }
            else{
                city_name = labels["county_2"][key];
            }

            stackChartData.data.datasets.push({
                label: city_name,
                data: value[selected_cat_val]
            })
        }
    }



}


function plotLine(){
    
    if (chart) chart.destroy();
    // console.log(dataset_data)
    
    // console.log(data_labels)
    reset_dataset();
    get_dataset("line");
    // console.log(lineChartData)
    chart = new Chart(ctx, lineChartData
    )
}

function plotStack(){
    if (chart) chart.destroy();
    reset_dataset();
    get_dataset("stack");
    chart = new Chart(ctx, stackChartData);
}




window.onload = function() {
    var cities;
    fetch("/city_compact.json").then(function(response) {
        return response.json();
    }).then(function(data) {
        var counties = data.items.filter(option=> option.city_ID == 'All');
        cities = data.items.filter(option=> option.city_ID != 'All');
        for(var i=0;i<counties.length;i++) {
            $(".option_county").each(function(){
                $(this).append(new Option(counties[i].county, counties[i].county_ID));
            })
        }
    }).catch(function(err) {
        console.log("Booo", err);
    });

    $(".option_county").change(function(){
        var selected_county = $(this).find("option:selected").val()
        var select_cities = cities.filter(option=> option.county_ID == selected_county);
        var changed_id = $(this).attr("id");
        $("."+changed_id).find('option').not(':first').remove();
        for(i in select_cities){
            $("."+changed_id).append(new Option(select_cities[i].city, select_cities[i].city_ID));
        }
    })


    $(".option_city").change(function(){
        var city_class = $(this).attr("class").split(' ')[1];
        var curr_county = $("#"+city_class)[0].value;
        var county_id = parseInt(curr_county);
        var city_id = parseInt(this.value);
        var city_name = $("option:selected", this).text()
        // labels[city_class] = [curr_county + this.value,city_name];
        labels[city_class] = {};
        labels[city_class][curr_county + this.value] = city_name;
        if (Object.keys(labels).length == 2){
            var keys = Object.values(labels).map(a => Object.keys(a))
            var cities = keys.map(a => a[0].substring(2,4))
            var counties = keys.map(a => a[0].substring(0,2))
            // var cities = Object.values(labels).map(a => a.substring(2,4));
            // var counties = Object.values(labels).map(a => a[0].substring(0,2));
            // console.log(cities)
            var url = "/categoryRegion?category_name="+feature.value+
                "&county_id=" + counties + "&city_id=" + cities;
            loadData(url); 
        }
    })
    $("#option_category_val").change(function(){
        plotLine();
    })


    

}



</script>

