<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Catetories Comparsions over Time and Region</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="/js/bootstrap-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js" integrity="sha512-R/QOHLpV1Ggq22vfDAWYOaMd5RopHrJNMxi8/lJu8Oihwi4Ho4BRFeiMiCefn9rasajKjnx9/fTQ/xkWnkDACg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
    <link href="/css/styles.css" rel="stylesheet" type="text/css"/>
    <link href="/css/category.css" rel="stylesheet" type="text/css"/>
    <link href="/css/datepicker.css" rel="stylesheet" type="text/css"/>
</head>

<body id="page-top">
    <div class="container">
      <div class="row mt-3 pb-3" style="border-bottom: 1px solid #ced4da;">
        <div class="col col-7 col-select">
          <div class="row mb-2">
              <div class="col col-6">
                  <select id="option_feature"  class="form-select"  autocomplete="off" >
                    <option value="" selected="selected" >Select Category</option>
                    <option value="pcf_violation_category">PCF Violation Category</option>
                    <option value="lighting">Lighting</option>
                </select>
              </div>
          </div>
          <div class="row mb-2">
            <div class="col col-6">
                <select class="option_county form-select" id="county_1" autocomplete="off" >
                    <option value="" selected="selected" >Select County</option>
                </select>
                
            </div>
            <div class="col col-6">
                <select class="option_city county_1 form-select" id="city_1" autocomplete="off" >
                    <option value="" selected="selected" >Select City</option>
                </select>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col col-6">
                <select class="option_county form-select" id="county_2" autocomplete="off" >
                    <option value="" selected="selected" >Select County</option>
                </select>
                
            </div>
            <div class="col col-6">
                <select class="option_city county_2 form-select" id="city_2" autocomplete="off" >
                    <option value="" selected="selected" >Select City</option>
                </select>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col col-6">
                <select id="option_category_val" class="form-select" autocomplete="off" >
                    <option value="" selected="selected" >Select Value</option>
                </select> 
            </div>
            <div class="tab col col-6 btn-group btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-secondary active">
                  <input type="radio" name="chart-type" onclick="plotLine()" value="line" autocomplete="off" checked> Line
                </label>
                <label class="btn btn-secondary">
                    <input type="radio"  name="chart-type" onclick="plotStack()" value="stack" autocomplete="off"> Stack
                </label>
          </div>
        </div>
        </div>
        
          </div>
          <div id="chart-wrapper">
            <canvas id="my-chart"></canvas>
          </div>

      </div>
    </div>

</body>   


<script>
const ctx = document.getElementById('my-chart');
const feature = document.getElementById("option_feature");

var labels = {}
var chart;
var dataset_data;
var category_values;
var lineChartData;
var stackChartData;
var selected_cities = {};
var city_id_name = {};

function init_data(){
  dataset_data = {};
//   data_labels = [];
  category_values = {};
//   data_labels = [];
}
function generateArray (start, end) {
    return Array.from(new Array(end + 1).keys()).slice(start)
}
var data_labels = generateArray(2001,2021);


function reset_dataset(){
    lineChartData=
    {
        type: 'line',
        data:{
            datasets: [],
            spanGaps: true
        },
        options:{
            plugins:{
                title: {
                display: true,
                text: 'Line Chart Comparsion between Two Cities'
                }
            }
        }
    };
    stackChartData=
    {
        type: 'bar',
        data:{
            datasets: []
        },
        options: {
            plugins: {
                title: {
                display: true,
                text: 'Stack Chart Comparsion between Two Cities'
                },
            },
            responsive: true,
            scales: {
                x: {
                stacked: true,
                },
                y: {
                stacked: true
                }
            }
        }
    };

}


function loadData(url, city_class) {
  fetch(url).then(function(response) {
      return response.json();
  }).then(function(data) {
      if (data.success) {
        data = data.payload;    
        let keys = Object.keys(data[0]);
        curr_feature = keys[0];
        // clear the existing data
        if(dataset_data[city_class]) dataset_data[city_class] = {};
        for(i in data){
            d = data[i];
            feature_val = d[curr_feature];
            // percent = d["percent"];
            collisions = d["num_collisions"];
            year = d['year'];
            county = d['county_ID'].toString();
            city = d['city_ID'].toString();
            if(county.length == 1){
                county = "0" + county;
            }
            if(city.length == 1){
                city = "0" + city;
            }
            county_city = "" + county + city;
            // if(!dataset_data[county_city]) dataset_data[county_city] = {}
            // if(!dataset_data[county_city][feature_val]) dataset_data[county_city][feature_val] = []
            // dataset_data[county_city][feature_val].push({x:year, y:collisions});
            selected_feature = $("#option_feature")[0].value
            if(Object.keys(category_values).indexOf(selected_feature) === -1) category_values[selected_feature]=[];
            if( (category_values[selected_feature].indexOf(feature_val) === -1)){
                category_values[selected_feature].push(feature_val);
            }
            city_name = labels[city_class][county_city];
            if(Object.keys(city_id_name).indexOf(city_class) === -1) city_id_name[city_class] = ""
            city_id_name[city_class] = city_name

            if(!dataset_data[city_class]) dataset_data[city_class] = {};
            if(!dataset_data[city_class][feature_val]) dataset_data[city_class][feature_val] = []
            dataset_data[city_class][feature_val].push({x:year, y:collisions})

        }

      }
      update_cat_value()
      if($("#option_category_val")[0].value !== ""){
            plot()
        }
  })
}

function get_dataset(chart_type){
    if(chart_type == 'line'){
        lineChartData.label = data_labels;
        lineChartData.data.labels = data_labels;
        selected_cat_val = $("#option_category_val")[0].value;
        for (const [key, value] of Object.entries(dataset_data)){
            // key: county_1/county_2
            // value: {sevrity:{year,collision}}
            var city_name = Object.values(labels[key])[0];
            var all_data = value[selected_cat_val];
            var all_years = all_data.map(a => a['x'])
            for(i in data_labels){
                if (all_years.indexOf(data_labels[i]) === -1){
                    all_data.push({x:data_labels[i],y:0})
                }
            }
            all_data.sort((a,b) => (a['x'] > b['x']) ? 1 : ((b['x'] > a['x']) ? -1 : 0))
            lineChartData.data.datasets.push({
                label: city_name,
                data: value[selected_cat_val],
                lineTension: 0.4,
                borderWidth: 1
            })


        }

    }
    else if(chart_type == 'stack'){
        stackChartData.label = data_labels;
        stackChartData.data.labels = data_labels;
        selected_cat_val = $("#option_category_val")[0].value;
        var city_name;

        for (const [key, value] of Object.entries(dataset_data)){
            city_name = Object.values(labels[key])[0]           
            var all_data = value[selected_cat_val]
            var all_years = all_data.map(a => a['x'])
            for(i in data_labels){
                if (all_years.indexOf(data_labels[i]) === -1){
                    all_data.push({x:data_labels[i],y:0})
            }
        }
            all_data.sort((a,b) => (a['x'] > b['x']) ? 1 : ((b['x'] > a['x']) ? -1 : 0))
            stackChartData.data.datasets.push({
                label: city_name,
                data: all_data,
                borderWidth: 1
            })
        }
    }



}

function update_cat_value(){
    if($("#option_category_val")[0].length === 1){
        $("#option_category_val").find('option').not(':first').remove()
        for (i in category_values[$("#option_feature")[0].value]){
            $("#option_category_val").append(new Option(category_values[$("#option_feature")[0].value][i]));
        }
    }
}
function plotLine(){
    
    if (chart) chart.destroy();
    reset_dataset();
    get_dataset("line");
    chart = new Chart(ctx, lineChartData
    )
}

function plotStack(){
    if (chart) chart.destroy();
    reset_dataset();
    get_dataset("stack");
    chart = new Chart(ctx, stackChartData);
}


function plot(){
    var chart_type = $('input[name="chart-type"]:checked').val();
    if(chart_type === "line") plotLine()
    else plotStack()
}


$("#option_feature").change(function(){
        $("#option_category_val").find('option').not(':first').remove()
        var selected_cities = []
        var selected_counties = []
        $(".option_city").each(function(){
            if($(this).find("option:selected").val() !== "")
            {
                temp_city = $(this).find("option:selected").val();
                temp_class = $(this).attr("class").split(' ')[1];
                temp_county = $("#" + temp_class )[0].value;
                var url = "/categoryRegionTime?category_name="+feature.value+
                "&county_id=" + temp_county + "&city_id=" + temp_city;
                loadData(url, temp_class);                  
            }
        })          
    })


window.onload = function() {
    var cities;
    init_data();
    fetch("/city_compact.json").then(function(response) {
        return response.json();
    }).then(function(data) {
        var counties = data.items.filter(option=> option.city_ID == 'All');
        cities = data.items.filter(option=> option.city_ID != 'All');
        for(var i=0;i<counties.length;i++) {
            $(".option_county").each(function(){
                county_name = counties[i].county;
                county_name = county_name.charAt(0) + county_name.substring(1).toLowerCase()
                $(this).append(new Option(county_name, counties[i].county_ID));
            })
        }
    }).catch(function(err) {
        console.log("Booo", err);
    });

    $(".option_county").change(function(){
        var selected_county = $(this).find("option:selected").val()
        var select_cities = cities.filter(option=> option.county_ID == selected_county);
        var changed_id = $(this).attr("id");
        $("."+changed_id).find('option').not(':first').remove();
        for(i in select_cities){
            city_name = select_cities[i].city;
            city_name = city_name.charAt(0) + city_name.substring(1).toLowerCase()
            $("."+changed_id).append(new Option(city_name, select_cities[i].city_ID));
        }
    })

    $(".option_city").change(function(){
        var city_class = $(this).attr("class").split(' ')[1];
        var curr_county = $("#"+city_class)[0].value;
        var county_id = parseInt(curr_county);
        var city_id = parseInt(this.value);
        var city_name = $("option:selected", this).text()
        city_name =  city_name.charAt(0) + city_name.substring(1).toLowerCase()
        labels[city_class] = {};
        labels[city_class][curr_county + this.value] = city_name;
        var url = "/categoryRegionTime?category_name="+feature.value+
                "&county_id=" + county_id + "&city_id=" + city_id;
        loadData(url, city_class);  

    })

    $("#option_category_val").change(function(){
        plot()

    })



    

}



</script>

