<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="/js/bootstrap-datepicker.js"></script>
        <link href="/css/styles.css" rel="stylesheet" />
        <link href="/css/loader.css" rel="stylesheet" />
        <link href="/css/chart.css" rel="stylesheet" />
        <link href="/css/datepicker.css" rel="stylesheet" type="text/css" />
        <title>CMPT 732 Project Website - Time Series Analysis</title>
    </head>
    <body id="page-top">
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar-shrink" id="mainNav">
            <div class="container">
                <a class="" href="/" style="text-decoration: none;font-weight: bold;font-size: 24px;"><img class="me-3" src="/android-chrome-192x192.png" style="height:50px;" alt="..." />Epic Byte</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars ms-1"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link" href="/#about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="/#objective">Objective</a></li>
                        <li class="nav-item"><a class="nav-link" href="/#analysis">Analysis</a></li>
                        <li class="nav-item"><a class="nav-link" href="/#team">Team</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <section class="page-section bg-light" id="point1">
            <div class="container">
                <div class="text-center">
                    <h2 class="section-heading text-uppercase">Time Series Chart</h2>
                    <h3 class="section-subheading text-muted mb-3">Data at a glance - accident, injury, and death counts by cities</h3>
                </div>
                <div class="row pb-3" style="border-bottom: 1px solid #ced4da;">
                    <div class="col col-7 col-select">
                        <div class="row mb-2">
                            <div class="col col-6">
                                <select id="option_county" class="form-select option_county" data-index="1">
                                    <option value="" selected="selected">Select County</option>
                                </select>
                            </div>
                            <div class="col col-6">
                                <select id="option_city" class="form-select option_city" data-index="1">
                                    <option value="-1" selected="selected">Select City</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col col-6">
                                <select id="option_county" class="form-select option_county" data-index="2">
                                    <option value="" selected="selected">Select County</option>
                                </select>
                            </div>
                            <div class="col col-6">
                                <select id="option_city" class="form-select option_city" data-index="2">
                                    <option value="-1" selected="selected">Select City</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col col-6">
                                <select id="option_county" class="form-select option_county" data-index="3">
                                    <option value="" selected="selected">Select County</option>
                                </select>
                            </div>
                            <div class="col col-6">
                                <select id="option_city" class="form-select option_city" data-index="3">
                                    <option value="-1" selected="selected">Select City</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col col-interval col-datepicker">
                        
                        <div class="rangepicker rangepicker-date">
                            <div class="input-group mb-2">
                                <span class="input-group-text" id="inputGroup-sizing-default">Start</span>
                                <input type="text" class="form-control" id="dpd1" value="2001-01-01" readonly>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text" id="inputGroup-sizing-default" style="padding-right: 18px;">End</span>
                                <input type="text" class="form-control" id="dpd2" value="2001-04-30" readonly>
                            </div>
                        </div>
                        <div class="rangepicker rangepicker-month hide">
                            <div class="input-group mb-2">
                                <span class="input-group-text" id="inputGroup-sizing-default">Start</span>
                                <input type="text" class="form-control" id="dpm1" value="2001-01-01" readonly>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text" id="inputGroup-sizing-default" style="padding-right: 18px;">End</span>
                                <input type="text" class="form-control" id="dpm2" value="2003-12-31" readonly>
                            </div>
                        </div>
                        <div class="rangepicker rangepicker-year hide">
                            <div class="input-group mb-2">
                                <span class="input-group-text" id="inputGroup-sizing-default">Start</span>
                                <input type="text" class="form-control" id="dpy1" value="2001-01-01" readonly>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text" id="inputGroup-sizing-default" style="padding-right: 18px;">End</span>
                                <input type="text" class="form-control" id="dpy2" value="2020-12-31" readonly>
                            </div>
                        </div>
                        <div class="row btn-group btn-group-toggle" data-toggle="buttons">
                            <div class="col col-12">
                                <label class="btn btn-secondary active">
                                    <input type="radio" name="frequency" data-target="rangepicker-date" onclick="frequency_change(this);" value="daily" id="option1" autocomplete="off" checked> Daily
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="frequency" data-target="rangepicker-month" onclick="frequency_change(this);" value="monthly" id="option2" autocomplete="off"> Monthly
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="frequency" data-target="rangepicker-year" onclick="frequency_change(this);" value="yearly" id="option3" autocomplete="off"> Yearly
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="container text-center">
                    <div class="spin hide"></div>
                    <div id="chart-wrapper" class="mt-3">
                        <canvas id="chart1"></canvas>
                    </div>
                    <div id="chart-wrapper" class="mt-3">
                        <canvas id="chart2"></canvas>
                    </div>
                    <div id="chart-wrapper" class="mt-3">
                    <canvas id="chart3"></canvas>
                    </div>
                </div>
                
                
                <script>
                
                    const colorLine = ['#003f5c', '#bc5090', '#ffa600']
                    const bgColorLine = ['#416E8E', '#D898BA', '#A27E52']
                    var nowTemp = new Date();
                    var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
                    
                    var minDate = new Date("2001-01-01");
                    var maxDate = new Date("2020-12-31");
                
                    var startDate = $('#dpd1').datepicker({
                        format: "yyyy-mm-dd",
                        onRender: function(date) {
                            return (date.valueOf() > maxDate.valueOf() || date.valueOf() < minDate.valueOf())  ? 'disabled' : '';
                        }
                    }).on('changeDate', function(ev) {
                        if (ev.date.valueOf() > endDate.date.valueOf()) {
                            var newDate = new Date(ev.date)
                            newDate.setDate(newDate.getDate() + 1);
                            endDate.setValue(newDate);
                        }
                        startDate.hide();
                        $('#dpd2')[0].focus();
                    }).data('datepicker');
                
                    var endDate = $('#dpd2').datepicker({
                        format: "yyyy-mm-dd",
                        onRender: function(date) {
                            return (date.valueOf() <= startDate.valueOf() || date.valueOf() > maxDate.valueOf()) ? 'disabled' : '';
                        }
                    }).on('changeDate', function(ev) {
                        if (ev.date.valueOf() < startDate.date.valueOf()) {
                            var newDate = new Date(ev.date)
                            newDate.setDate(newDate.getDate() - 1);
                            startDate.setValue(newDate);
                            //$('#dpd1').val(ev.date.toISOString().substring(0,10));
                        }
                        endDate.hide();
                        updateAllChart();
                    }).data('datepicker');
                
                    var startMonth = $('#dpm1').datepicker({
                        viewMode: 1,
                        minViewMode: 1,
                        format: "yyyy-mm-dd",
                        onRender: function(date) {
                            return (date.valueOf() > maxDate.valueOf() || date.valueOf() < minDate.valueOf())  ? 'disabled' : '';
                        }
                    }).on('changeDate', function(ev) {
                        if (ev.date.valueOf() > endMonth.date.valueOf()) {
                            console.log('greater??');
                            var newDate = new Date(ev.date)
                            newDate.setDate(newDate.getDate() + 1);
                            endMonth.setValue(newDate);
                        }
                        $('#dpm1').val(ev.date.toISOString().substring(0,10));
                        startMonth.hide();
                        $('#dpm2')[0].focus();
                    }).data('datepicker');
                
                    var endMonth = $('#dpm2').datepicker({
                        viewMode: 1,
                        minViewMode: 1,
                        format: "yyyy-mm-dd",
                        onRender: function(date) {
                            let endMaxDate = new Date($('#dpm1').val());
                            endMaxDate.setFullYear(endMaxDate.getFullYear() +1);
                            endMaxDate.setDate(endMaxDate.getDate() -1);
                            return (date.valueOf() <= startMonth.valueOf() || date.valueOf() > endMaxDate.valueOf() || date.valueOf() > maxDate.valueOf()) ? 'disabled' : '';
                        }
                    }).on('changeDate', function(ev) {
                        $('#dpm2').val(ev.date.toISOString().substring(0,10));
                        if (ev.date.valueOf() < startMonth.date.valueOf()) {
                            var target_date = new Date(minDate);
                            target_date.setDate(target_date.getDate()+1);
                            startMonth.setValue(target_date);
                        }
                        endMonth.hide();
                        updateAllChart();
                    }).data('datepicker');
                
                    var startYear = $('#dpy1').datepicker({
                        viewMode: 2,
                        minViewMode: 2,
                        format: "yyyy-mm-dd",
                        onRender: function(date) {
                            return (date.valueOf() > maxDate.valueOf() || date.valueOf() < minDate.valueOf())  ? 'disabled' : '';
                        }
                    }).on('changeDate', function(ev) {
                        if (ev.date.valueOf() > endYear.date.valueOf()) {
                            var newDate = new Date(ev.date)
                            newDate.setDate(newDate.getDate() + 1);
                            endYear.setValue(newDate);
                        }
                        $('#dpy1').val(ev.date.toISOString().substring(0,4));
                        startYear.hide();
                        $('#dpy2')[0].focus();
                    }).on('hide', function(ev){
                        $('#dpy1').val($('#dpy1').val().substring(0,4))
                    }).data('datepicker');
                
                    var endYear = $('#dpy2').datepicker({
                        viewMode: 2,
                        minViewMode: 2,
                        format: "yyyy-mm-dd",
                        onRender: function(date) {
                            let endMaxDate = new Date($('#dpy1').val());
                            endMaxDate.setMonth(endMaxDate.getMonth() +1);
                            endMaxDate.setDate(endMaxDate.getDate() -1);
                            return (date.valueOf() <= startYear.valueOf() || date.valueOf() > endMaxDate.valueOf() || date.valueOf() > maxDate.valueOf()) ? 'disabled' : '';
                        }
                    }).on('changeDate', function(ev) {
                        endYear.hide();
                        $('#dpy2').val(ev.date.toISOString().substring(0,4));
                        updateAllChart();
                    }).on('hide', function(ev){
                        $('#dpy2').val($('#dpy2').val().substring(0,4))
                    }).data('datepicker');
                
                    const ctx1 = document.getElementById('chart1');
                    const ctx2 = document.getElementById('chart2');
                    const ctx3 = document.getElementById('chart3');
                    var cities;
                    var chart1;
                    var chart2;
                    var chart3;
                
                    function updateAllChart() {
                        if (chart1) {
                            chart1.destroy()
                            chart2.destroy()
                            chart3.destroy()
                            chart1 = undefined;
                            chart2 = undefined;
                            chart3 = undefined;
                        }
                        $('.spin').removeClass('hide');
                        updateChart(1).then(function(){
                            updateChart(2).then(function(){
                                updateChart(3).then(function(){
                                    $('.spin').addClass('hide');
                                });
                            })
                        })
                    }
                
                    // index 1: startDate index 2: EndDate
                    function getDateValue(frequency, index) {
                        if (frequency == 'yearly') {
                            return $('#dpy'+index).val().substring(0,4)
                        } else if (frequency == 'monthly') {
                            return $('#dpm'+index).val()
                        } else {
                            return $('#dpd'+index).val()
                        }
                    }
                
                    function updateChart(index) {
                        return new Promise(function(myResolve, myReject) {
                            var checked_frequency = document.querySelector('input[name = "frequency"]:checked');
                            var target_county = $('.option_county[data-index='+index+']').eq(0);
                            var target_city = $('.option_city[data-index='+index+']').eq(0);
                            var url = "/collisions?frequency="+checked_frequency.value
                                +"&county_id="+parseInt(target_county.val())
                                +'&city_id='+parseInt(target_city.val())
                                +'&start='+getDateValue(checked_frequency.value, 1)
                                +'&end='+getDateValue(checked_frequency.value, 2)
                            if (target_city.val() != -1) {
                                loadChart(url, index).then(function(){myResolve();}).catch(function(){myResolve();});
                            } else {
                                myResolve();
                            }
                        });
                    }
                
                    function frequency_change(radio_btn) {
                        console.log('target:', $(radio_btn).attr('data-target'))
                        $('.rangepicker').addClass('hide');
                        $('.'+$(radio_btn).attr('data-target')).removeClass('hide');
                        var checked_frequency = document.querySelector('input[name = "frequency"]:checked');
                        const frequencyToWords = {
                            'daily': 0,
                            'monthly': 1,
                            'yearly': 2
                        }
                        console.log('new mode: ', frequencyToWords[checked_frequency.value]);
                        $('#dpd1').datepicker({
                            viewMode: frequencyToWords[checked_frequency.value],
                            minViewMode: frequencyToWords[checked_frequency.value],
                        });
                        updateAllChart();
                    }
                
                    function drawChart(chart, target_element, index, title_name, borderColor, dataset) {
                        if (chart != undefined) {
                            // check if the index is greater than what we have
                            const data_length = chart.data.datasets.length;
                            console.log('drawing...', index, data_length);
                            if (index > data_length) {
                                //append it
                                chart.data.datasets.push({
                                    label: $('.option_county[data-index='+index+'] option:selected').eq(0).text()+' - '+$('.option_city[data-index='+index+'] option:selected').eq(0).text(),
                                    data: dataset,
                                    borderWidth: 1,
                                    lineTension: 0.4,
                                    borderColor: colorLine[index-1],
                                    backgroundColor: bgColorLine[index-1]       
                                });
                                console.log('append?')
                            } else {
                                //update the existing one
                                if (chart.data.datasets.length < index-1) {
                                    console.log('not enough space?');
                                }
                                chart.data.datasets[index-1].label = $('.option_county[data-index='+index+'] option:selected').eq(0).text()+' - '+$('.option_city[data-index='+index+'] option:selected').eq(0).text()
                                chart.data.datasets[index-1].data = dataset;
                                console.log('update', index, chart.data.datasets);
                            }
                            chart.options.scales.x.min = getMinDateString();
                            chart.update();
                            return chart
                        } else {
                            chart = new Chart(target_element, {
                                type: 'line',
                                data: {
                                    datasets: [{
                                        label: $('.option_county[data-index='+index+'] option:selected').eq(0).text()+' - '+$('.option_city[data-index='+index+'] option:selected').eq(0).text(),
                                        data: dataset,
                                        borderWidth: 1,
                                        lineTension: 0.4,
                                        borderColor: colorLine[index-1],
                                        backgroundColor: bgColorLine[index-1]          
                                    }]
                                },
                                options: {
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: title_name,
                                            font: {
                                                size: 24
                                            }
                                        }
                                    },
                                    responsive: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                min: 0,
                                                callback: function(value, index, values) {
                                                    if (Math.floor(value) === value) {
                                                        return value;
                                                    }
                                                }
                                            }
                                        },
                                        x: {
                                            min: getMinDateString(),
                                            grid: {
                                                display: false
                                            },
                                        }
                                    }
                                }
                            });
                            return chart
                        }
                            
                    }
                
                    function getMinDateString() {
                        var checked_frequency = document.querySelector('input[name = "frequency"]:checked').value;
                        if (checked_frequency == "monthly") {
                            return getDateValue(checked_frequency, 1).substring(0, 7);
                        } else if (checked_frequency == "yearly") {
                            return getDateValue(checked_frequency, 1);
                        } else {
                            return getDateValue(checked_frequency, 1);
                        }
                        
                    }
                
                    function getCollisionDate(data) {
                        var checked_frequency = document.querySelector('input[name = "frequency"]:checked').value;
                        if (checked_frequency == "monthly") {
                            return data.collision_month.substring(0, 7);
                        } else if (checked_frequency == "yearly") {
                            return data.collision_year;
                        } else {
                            return data.collision_date.substring(0, 10);
                        }
                    }
                
                    function loadChart(url, index) {
                        return new Promise(function(myResolve, myReject) {
                            fetch(url).then(function(response) {
                                return response.json();
                            }).then(function(data) {
                                if (data.success) {
                                    const d = data.payload;
                                    var checked_frequency = document.querySelector('input[name = "frequency"]:checked').value;
                                    var dataset = [];
                                    var injured_dataset = [];
                                    var killed_dataset = [];
                                    if (checked_frequency == 'yearly') {
                                        var current_date = parseInt($('#dpy1').val().substring(0,4));
                                        var end_date = parseInt($('#dpy2').val().substring(0,4));
                                        for (var i=0;i<d.length;i++) {
                                            var collision_date = parseInt(getCollisionDate(d[i]));//.collision_date.substring(0, 10);
                                            while(current_date != collision_date) {
                                                dataset.push({x:current_date.toString(), y:0});
                                                injured_dataset.push({x:current_date.toString(), y:0});
                                                killed_dataset.push({x:current_date.toString(), y:0});
                                                current_date++;
                                                if (current_date == collision_date) {
                                                    break;
                                                }
                                            } 
                    
                                            dataset.push({x:getCollisionDate(d[i]).toString(), y:d[i].num_accidents});
                                            injured_dataset.push({x:getCollisionDate(d[i]).toString(), y:d[i].total_injured});
                                            killed_dataset.push({x:getCollisionDate(d[i]).toString(), y:d[i].total_killed});
                                            current_date++;
                                        }
                                        current_date--;
                                        while(current_date != end_date) {
                                            dataset.push({x:current_date.toString(), y:0});
                                            injured_dataset.push({x:current_date.toString(), y:0});
                                            killed_dataset.push({x:current_date.toString(), y:0});
                                            current_date++;
                                        } 
                                    } else if (checked_frequency == 'monthly') {
                                        var current_date = new Date($('#dpm1').val());
                                        var end_date = new Date($('#dpm2').val());
                                        for (var i=0;i<d.length;i++) {
                                            var collision_date = getCollisionDate(d[i]);//.collision_date.substring(0, 10);
                                            while(current_date.toISOString().substring(0, 7) != collision_date) {
                                                dataset.push({x:current_date.toISOString().substring(0, 7), y:0});
                                                injured_dataset.push({x:current_date.toISOString().substring(0, 7), y:0});
                                                killed_dataset.push({x:current_date.toISOString().substring(0, 7), y:0});
                                                current_date.setUTCDate(2);
                                                current_date.setUTCMonth(current_date.getUTCMonth()+1, 1);
                                                if (current_date.toISOString().substring(0, 7) == collision_date) {
                                                    break;
                                                }
                                            } 
                                            dataset.push({x:getCollisionDate(d[i]), y:d[i].num_accidents});
                                            injured_dataset.push({x:getCollisionDate(d[i]), y:d[i].total_injured});
                                            killed_dataset.push({x:getCollisionDate(d[i]), y:d[i].total_killed});
                                            current_date.setUTCDate(2);
                                            current_date.setUTCMonth(current_date.getUTCMonth()+1);
                                        }
                                        current_date.setUTCDate(2);
                                        current_date.setUTCMonth(current_date.getUTCMonth()-1);
                                        while(current_date.toISOString().substring(0, 7) != end_date.toISOString().substring(0, 7)) {
                                            dataset.push({x:current_date.toISOString().substring(0, 7), y:0});
                                            injured_dataset.push({x:current_date.toISOString().substring(0, 7), y:0});
                                            killed_dataset.push({x:current_date.toISOString().substring(0, 7), y:0});
                                            current_date.setUTCDate(2);
                                            current_date.setUTCMonth(current_date.getUTCMonth()+1, 1);
                                            break;
                                        } 
                                    } else if (checked_frequency == 'daily') {
                                        var current_date = new Date($('#dpd1').val());
                                        var end_date = new Date($('#dpd2').val());
                                        for (var i=0;i<d.length;i++) {
                    
                                            var collision_date = getCollisionDate(d[i]);
                                            while(current_date.toISOString().substring(0, 10) != collision_date) {
                                                dataset.push({x:current_date.toISOString().substring(0, 10), y:0});
                                                injured_dataset.push({x:current_date.toISOString().substring(0, 10), y:0});
                                                killed_dataset.push({x:current_date.toISOString().substring(0, 10), y:0});
                                                current_date.setDate(current_date.getDate()+1);
                                                if (current_date.toISOString().substring(0, 10) == collision_date) {
                                                    break;
                                                }
                                            } 
                    
                                            dataset.push({x:d[i].collision_date.substring(0, 10), y:d[i].num_accidents});
                                            injured_dataset.push({x:d[i].collision_date.substring(0, 10), y:d[i].total_injured});
                                            killed_dataset.push({x:d[i].collision_date.substring(0, 10), y:d[i].total_killed});
                                            current_date.setDate(current_date.getDate()+1);
                                        }
                                        current_date.setDate(current_date.getDate()-1);
                                        while(current_date.toISOString().substring(0, 10) != end_date.toISOString().substring(0, 10)) {
                                            dataset.push({x:current_date.toISOString().substring(0, 10), y:0});
                                            injured_dataset.push({x:current_date.toISOString().substring(0, 10), y:0});
                                            killed_dataset.push({x:current_date.toISOString().substring(0, 10), y:0});
                                            current_date.setDate(current_date.getDate()+1);
                                        } 
                                    }
                                    
                                    console.log('finish load chart index', index, dataset);
                                    chart1 = drawChart(chart1, ctx1, index, 'Number of Accidents Occured', '#212529', dataset);
                                    chart2 = drawChart(chart2, ctx2, index, 'Number of People Injured from Accidents', '#F9F871', injured_dataset);
                                    chart3 = drawChart(chart3, ctx3, index, 'Number of People Died from Accidents', '#E5BBCE', killed_dataset);
                                    myResolve();
                                }
                            }).catch(function(err) {
                                myReject(err);
                            });
                        });
                        
                    }
                
                    $(document).ready(function(){
                        $('.option_county').change(option_county_change_callback)
                        $('.option_city').change(option_city_change_callback)
                    });
                    
                    var option_county_change_callback = function(event) {
                        //empty cities dropdowns
                        var index = $(this).attr('data-index');
                        var target = $('.option_city[data-index='+index+']').eq(0);
                        target.find('option').not(':first').remove();
                        //display correct values
                        var select_cities = cities.filter(option=> option.county_ID == this.value);
                        for(var i=0;i<select_cities.length;i++) {
                            target.append(new Option(select_cities[i].city, select_cities[i].city_ID));
                        }
                    }
                
                    var option_city_change_callback = function(event) {
                        var index = $(this).attr('data-index');
                        $('.spin').removeClass('hide');
                        updateChart(index).then(function(){
                            $('.spin').addClass('hide');
                        });
                    }
                
                    window.onload = function() {
                        const option_county = document.getElementsByClassName('option_county');
                        const option_city = document.getElementsByClassName('option_city');
                        console.log('option_county',option_county);
                        fetch("/city_compact.json").then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            var counties = data.items.filter(option=> option.city_ID == 'All');
                            cities = data.items.filter(option=> option.city_ID != 'All');
                            for(var i=0;i<counties.length;i++) {
                                for(var j=0;j<option_county.length;j++) {
                                    option_county[j].options[option_county[j].options.length] = new Option(counties[i].county, counties[i].county_ID);
                                }
                                
                            }
                        }).catch(function(err) {
                            console.log("Booo", err);
                        });
                    }       
                </script>
            </div>
        </section>
        
    </body>
</html>
